# 📝 JWT 및 세션 기반 하이브리드 인증 설명서

이 프로젝트는 **JWT (JSON Web Token)를 사용한 토큰 기반 인증**을 핵심으로 사용하면서, 더 강력하고 즉각적인 로그아웃 처리를 위해 **서버의 상태 관리(세션 또는 토큰 블랙리스트)를 결합한 하이브리드 방식**을 채택했습니다.

이 방식은 JWT의 장점인 무상태(Stateless) 구조를 유지하면서도, 상태가 필요한 특정 기능(즉시 로그아웃)을 안정적으로 구현할 수 있게 합니다.

---

### 🤔 왜 하이브리드 방식인가? (JWT의 로그아웃 문제)

JWT는 한 번 발급되면 유효기간이 만료될 때까지 유효하다는 특징이 있습니다. 이는 서버가 토큰의 상태를 일일이 관리하지 않아도 되기 때문에 큰 장점이지만, **로그아웃 시 문제가 발생**합니다.

사용자가 '로그아웃' 버튼을 눌러 프론트엔드에서 토큰을 삭제하더라도, 누군가 탈취했던 해당 토큰은 유효기간이 남아있다면 여전히 서버에 접근하는 데 사용될 수 있습니다.

이 문제를 해결하기 위해, 서버가 "이 토큰은 더 이상 사용하면 안 된다"고 기억하는 **상태 관리(Stateful) 메커니즘**이 필요합니다.

---

### 🌊 전체 흐름 (Flowchart)

#### 1. 로그인 과정 (JWT 발급)
```
1. 사용자 (브라우저)
   - 아이디/비밀번호 입력 후 '로그인' 버튼 클릭
   - 로그인 요청 (POST /users/login)
     |
     v
2. 프론트엔드 (React)
   - Axios를 통해 백엔드로 API 요청
     |
     v
3. 백엔드 (Spring Boot)
   - UserController: 요청 수신
   - UserService: 아이디/비밀번호 검증
   - JwtUtil: 검증 성공 시, 사용자 정보를 담은 JWT 생성
   - 생성된 JWT를 응답으로 프론트엔드에 전송
     |
     v
4. 프론트엔드 (React)
   - 응답으로 받은 JWT를 브라우저의 'localStorage'에 저장
   - 사용자 상태(user)를 '로그인'으로 변경하고 메인 페이지로 이동
```

#### 2. 로그아웃 과정 (세션/블랙리스트 활용)
```
1. 사용자 (브라우저)
   - '로그아웃' 버튼 클릭
   - 로그아웃 요청 (POST /users/logout)
     |
     v
2. 프론트엔드 (React)
   - (Axios 인터셉터) 현재 JWT를 헤더에 담아 백엔드로 API 요청
     |
     v
3. 백엔드 (Spring Boot)
   - LogoutController: 요청 수신
   - LogoutService: 현재 토큰을 '무효화 목록(블랙리스트)'에 추가
   - (예: Redis나 캐시에 토큰의 남은 유효기간 동안 저장)
   - 성공 응답 전송
     |
     v
4. 프론트엔드 (React)
   - localStorage에서 JWT 삭제
   - 사용자 상태를 '로그아웃'으로 변경하고 로그인 페이지로 이동
```

#### 3. 인증이 필요한 API 요청 과정 (블랙리스트 검증 추가)
```
1. 사용자 (브라우저)
   - 글쓰기 등 인증이 필요한 기능 요청
     |
     v
2. 프론트엔드 (React)
   - (Axios 인터셉터) localStorage에서 JWT를 꺼내 HTTP 요청 헤더에 자동으로 추가
   - Authorization: "Bearer {JWT}"
     |
     v
3. 백엔드 (Spring Boot)
   - JwtFilter (Gatekeeper): 요청을 가로채 헤더의 JWT 검증
   - 1단계: 토큰의 서명 및 유효기간 등 기본 유효성 검증
   - 2단계: **블랙리스트에 해당 토큰이 있는지 확인**
   - 검증 성공 시: 요청을 컨트롤러로 전달
   - 검증 실패 시 (블랙리스트에 있을 경우 포함): 401 Unauthorized 에러 응답
     |
     v
4. 백엔드 (Controller/Service)
   - 요청된 작업 수행 후 결과 응답
```

---

### ⚙️ 주요 구성 요소 및 역할

#### 1. 백엔드 (Backend)

-   **`JwtUtil.java` (토큰 공장)**: JWT를 **생성**하고 기본 **검증**을 수행합니다.
-   **`UserController.java` (로그인 창구)**: `/users/login` 요청을 처리하여 JWT를 발급합니다.
-   **`LogoutService.java` (토큰 무효화 처리기)**: 로그아웃 요청 시 전달된 토큰을 **블랙리스트**에 등록하여 무효화시킵니다. 이 블랙리스트는 Redis, EhCache 같은 캐시 서버나 간단한 DB 테이블로 구현될 수 있습니다.
-   **`JwtFilter.java` (강화된 문지기)**: 모든 API 요청의 문지기 역할을 합니다. 토큰의 기본 유효성 검사뿐만 아니라, **해당 토큰이 블랙리스트에 등록되어 있는지까지 추가로 확인**하여 로그아웃된 토큰의 접근을 완벽하게 차단합니다.
-   **`SecurityConfig.java` (보안 규칙 설정집)**: `JwtFilter`를 필터 체인에 등록하고, API 경로별 접근 권한을 설정합니다.

#### 2. 프론트엔드 (Frontend)

-   **`localStorage` (브라우저의 금고)**: 로그인 시 발급받은 JWT를 저장합니다.
-   **`api/axios.js` (자동 서명기)**: 백엔드로 API 요청 시 `localStorage`의 JWT를 헤더에 자동으로 첨부합니다.
-   **`App.jsx` (상태 관리자)**: 로그인/로그아웃 로직을 총괄하며, 로그아웃 시 `localStorage`의 토큰을 반드시 삭제합니다.

---

### ✅ 요약 및 장점

-   **높은 보안성**: JWT의 기본 보안 기능에 더해, 서버 측 블랙리스트를 통해 탈취된 토큰의 재사용을 즉시 막을 수 있습니다.
-   **즉각적인 로그아웃**: 사용자가 로그아웃하는 즉시 해당 토큰은 시스템에서 완전히 무효화됩니다.
-   **유연한 구조**: JWT의 무상태(Stateless) 장점을 대부분 유지하면서, 필요한 부분에만 상태 관리(Stateful)를 도입하여 단점을 보완하는 유연한 구조입니다.
